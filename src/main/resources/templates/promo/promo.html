<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Promo Code for Events</title>
    <style>
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 5px;
            width: 80%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .promo-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .promo-controls {
            margin-top: 10px;
        }

        .promo-controls a,
        .promo-controls button {
            margin-right: 10px;
            padding: 5px 10px;
            text-decoration: none;
            border: 1px solid #007bff;
            border-radius: 3px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        .promo-controls a:hover,
        .promo-controls button:hover {
            background-color: #0056b3;
        }

        .promo-controls .delete-btn {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .promo-controls .delete-btn:hover {
            background-color: #c82333;
        }

        .percentage-badge {
            background-color: #4e73df;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .fixed-badge {
            background-color: #1cc88a;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .active-badge {
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .expired-badge {
            background-color: #6c757d;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
<h1 th:text="${userRole == T(backend.eventsphere.auth.model.User.UserRole).ORGANIZER}
              ? 'Sistem Manajemen Kode Promo'
              : 'Daftar Promo'"></h1>
<div style="display: flex; gap: 5px; margin-bottom: 20px;">
    <button id="back-to-events-btn" class="btn btn-secondary">Kembali ke Acara</button>
    <button id="add-promo-btn" class="btn" style="display:none;">Tambah Promo</button>
</div>
<div id="promos-container"></div>

<!-- Add Promo Modal -->
<div id="add-promo-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="add-modal-close">&times;</span>
        <h2>Tambah Promo Baru</h2>
        <form id="add-promo-form">
            <div class="form-group">
                <label for="add-promo-code">Kode Promo:</label>
                <input type="text" id="add-promo-code" name="code" required>
            </div>
            <div class="form-group" style="display: none;">
                <label for="add-event-id">Event ID:</label>
                <input type="text" id="add-event-id" name="eventId" th:value="${eventId}" readonly>
            </div>
            <div class="form-group">
                <label for="add-discount-type">Jenis Diskon:</label>
                <select id="add-discount-type" name="discountType" required>
                    <option value="">Pilih jenis...</option>
                    <option value="PERCENTAGE">Persentase</option>
                    <option value="FIXED_AMOUNT">Jumlah Tetap</option>
                </select>
            </div>
            <div class="form-group">
                <label for="add-discount-value">Nilai Diskon:</label>
                <div style="display: flex;">
                    <input type="number" id="add-discount-value" name="discountValue" step="0.01" min="0" required style="flex: 1;">
                    <span id="discount-suffix" style="padding: 8px; background: #eee; border: 1px solid #ddd; border-left: none; border-radius: 0 4px 4px 0;">%</span>
                </div>
            </div>
            <div class="form-group">
                <label for="add-start-date">Tanggal Mulai:</label>
                <input type="date" id="add-start-date" name="startDate" required>
            </div>
            <div class="form-group">
                <label for="add-end-date">Tanggal Berakhir:</label>
                <input type="date" id="add-end-date" name="endDate" required>
            </div>
            <button type="submit" class="btn">Tambah Promo</button>
            <button type="button" class="btn btn-secondary" id="add-modal-cancel">Batal</button>
        </form>
    </div>
</div>

<!-- Edit Promo Modal -->
<div id="edit-promo-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="edit-modal-close">&times;</span>
        <h2>Edit Promo</h2>
        <form id="edit-promo-form">
            <input type="hidden" id="edit-promo-id">
            <div class="form-group">
                <label for="edit-promo-code">Kode Promo:</label>
                <input type="text" id="edit-promo-code" name="code" required>
            </div>
            <div class="form-group">
                <label for="edit-event-id">Event ID:</label>
                <input type="text" id="edit-event-id" name="eventId" readonly>
            </div>
            <div class="form-group">
                <label for="edit-discount-type">Jenis Diskon:</label>
                <input type="text" id="edit-discount-type" readonly>
            </div>
            <div class="form-group">
                <label for="edit-discount-value">Nilai Diskon:</label>
                <input type="number" id="edit-discount-value" name="discountValue" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label for="edit-start-date">Tanggal Mulai:</label>
                <input type="date" id="edit-start-date" name="startDate" required>
            </div>
            <div class="form-group">
                <label for="edit-end-date">Tanggal Berakhir:</label>
                <input type="date" id="edit-end-date" name="endDate" required>
            </div>
            <button type="submit" class="btn">Perbarui Promo</button>
            <button type="button" class="btn btn-secondary" id="edit-modal-cancel">Batal</button>
        </form>
    </div>
</div>

<script>
    const eventId = "[[${eventId}]]";

    document.getElementById('back-to-events-btn').onclick = function() {
        window.location.href = '/events/'
    };

    async function fetchUserRole() {
        try {
            const response = await fetch('/api/auth/role', {
                method: 'GET',
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Gagal mengambil peran pengguna');
            }

            const data = await response.json();
            return data.role;
        } catch (error) {
            console.error('Error mengambil peran pengguna:', error);
            return null;
        }
    }

    async function checkRole() {
        const role = await fetchUserRole();

        if (role === 'ORGANIZER') {
            const addPromoBtn = document.getElementById('add-promo-btn');
            addPromoBtn.style.display = 'block';
            addPromoBtn.onclick = openAddPromoModal;
        }
        return role;
    }

    async function getCurrentUserId() {
        try {
            const response = await fetch('/api/auth/user-id', {
                method: 'GET',
                credentials: 'include'
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Response tidak OK:', errorText);
                throw new Error(errorText || 'Gagal mengambil user ID');
            }

            const data = await response.json();

            if (!data.userId) {
                console.error('Format response tidak valid:', data);
                throw new Error('Format data user ID tidak valid');
            }

            return data.userId;

        } catch (error) {
            console.error('Error dalam getCurrentUserId:', {
                error: error,
                message: error.message,
                stack: error.stack
            });
            return null;
        }
    }

    // Modal functions
    function openAddPromoModal() {
        document.getElementById('add-event-id').value = eventId;
        document.getElementById('add-promo-modal').style.display = 'block';
    }

    function closeAddPromoModal() {
        document.getElementById('add-promo-modal').style.display = 'none';
        document.getElementById('add-promo-form').reset();
    }

    function openEditPromoModal(promo) {
        document.getElementById('edit-promo-id').value = promo.id;
        document.getElementById('edit-promo-code').value = promo.code;
        document.getElementById('edit-event-id').value = promo.eventId;
        document.getElementById('edit-discount-type').value = promo.discountType === 'PERCENTAGE' ? 'Persentase' : 'Jumlah Tetap';

        const discountValue = promo.discountType === 'PERCENTAGE' ? promo.discount * 100 : promo.discount;
        document.getElementById('edit-discount-value').value = discountValue;

        document.getElementById('edit-start-date').value = promo.startDate.split('T')[0];
        document.getElementById('edit-end-date').value = promo.endDate.split('T')[0];
        document.getElementById('edit-promo-modal').style.display = 'block';
    }

    function closeEditPromoModal() {
        document.getElementById('edit-promo-modal').style.display = 'none';
        document.getElementById('edit-promo-form').reset();
    }

    // Modal event listeners
    document.getElementById('add-modal-close').onclick = closeAddPromoModal;
    document.getElementById('add-modal-cancel').onclick = closeAddPromoModal;
    document.getElementById('edit-modal-close').onclick = closeEditPromoModal;
    document.getElementById('edit-modal-cancel').onclick = closeEditPromoModal;

    document.getElementById('add-discount-type').addEventListener('change', function() {
        const suffix = this.value === 'PERCENTAGE' ? '%' : 'IDR';
        document.getElementById('discount-suffix').textContent = suffix;
    });

    window.onclick = function(event) {
        const addModal = document.getElementById('add-promo-modal');
        const editModal = document.getElementById('edit-promo-modal');
        if (event.target === addModal) {
            closeAddPromoModal();
        }
        if (event.target === editModal) {
            closeEditPromoModal();
        }
    }

    document.getElementById('add-promo-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const role = await checkRole();
        const userId = await getCurrentUserId();

        if (role !== 'ORGANIZER' || !userId) {
            alert('Hanya ORGANIZER yang bisa membuat promo');
            return;
        }

        try {
            const code = document.getElementById('add-promo-code').value;
            const eventId = document.getElementById('add-event-id').value;
            const discountType = document.getElementById('add-discount-type').value;
            let discountValue = parseFloat(document.getElementById('add-discount-value').value);
            const startDate = document.getElementById('add-start-date').value;
            const endDate = document.getElementById('add-end-date').value;

            const formatDate = (isoDate) => {
                const [year, month, day] = isoDate.split('-');
                return `${day}-${month}-${year}`;
            };

            const params = new URLSearchParams();
            params.append('code', code);
            params.append('eventId', eventId);
            params.append('promoType', discountType.toLowerCase());

            if (discountType === 'PERCENTAGE') {
                params.append('amount', Math.round(discountValue * 100).toString());
            } else {
                params.append('amount', Math.round(discountValue).toString());
            }

            params.append('startDate', formatDate(startDate));
            params.append('endDate', formatDate(endDate));
            params.append('createdBy', userId);

            const response = await fetch('/api/promos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params,
                credentials: 'include'
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Gagal membuat promo');
            }

            alert('Promo berhasil dibuat!');
            closeAddPromoModal();
            await loadPromos();

        } catch (error) {
            console.error('Create promo error:', error);
            alert(`Gagal membuat promo: ${error.message}`);
        }
    });

    document.getElementById('edit-promo-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formatDate = (isoDate) => {
            const [year, month, day] = isoDate.split('-');
            return `${day}-${month}-${year}`;
        };

        const params = new URLSearchParams();
        params.append('code', document.getElementById('edit-promo-code').value);

        const discountType = document.getElementById('edit-discount-type').value === 'Persentase' ? 'PERCENTAGE' : 'FIXED_AMOUNT';
        const discountValue = document.getElementById('edit-discount-value').value;

        if (discountType === 'PERCENTAGE') {
            params.append('discount', (parseFloat(discountValue) / 100));
        } else {
            params.append('discount', discountValue);
        }

        params.append('startDate', formatDate(document.getElementById('edit-start-date').value));
        params.append('endDate', formatDate(document.getElementById('edit-end-date').value));

        try {
            const response = await fetch(`/api/promos/${document.getElementById('edit-promo-id').value}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params,
                credentials: 'include'
            });

            if (!response.ok) throw new Error(await response.text());

            alert('Promo berhasil diperbarui!');
            closeEditPromoModal();
            await loadPromos();
        } catch (error) {
            console.error('Error:', error);
            alert(`Gagal memperbarui promo: ${error.message}`);
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        if (eventId) {
            document.getElementById('add-event-id').value = eventId;
        }
    });

    async function loadPromos() {
        const role = await checkRole();

        try {
            const response = await fetch(`/api/promos/event/${eventId}`, {
                method: 'GET',
                credentials: 'include',
            });

            if (!response.ok) {
                if (response.status === 404) {
                    const container = document.getElementById('promos-container');
                    container.innerHTML = '<p>Tidak ada promo untuk event ini.</p>';
                    return;
                } else if (response.status === 403) {
                    throw new Error('Akses ditolak. Tidak memiliki izin.');
                } else if (response.status === 401) {
                    throw new Error('Tidak sah. Silakan login.');
                }
                throw new Error('Gagal mengambil promo');
            }

            const promos = await response.json();
            const container = document.getElementById('promos-container');

            if (!promos.length) {
                container.innerHTML = '<p>Tidak ada promo untuk event ini.</p>';
                return;
            }

            container.innerHTML = '';
            promos.forEach(promo => {
                const today = new Date();
                const startDate = new Date(promo.startDate);
                const endDate = new Date(promo.endDate);
                const isActive = today >= startDate && today <= endDate;

                const discountValue = promo.discountType === 'PERCENTAGE'
                    ? `${(promo.discount * 100)}%`
                    : `IDR ${promo.discount.toLocaleString()}`;

                const div = document.createElement('div');
                div.className = 'promo-item';
                div.innerHTML = `
                    <div>
                        <strong>${promo.code}</strong>
                        <span class="${promo.discountType === 'PERCENTAGE' ? 'percentage-badge' : 'fixed-badge'}">
                            ${promo.discountType === 'PERCENTAGE' ? 'Persentase' : 'Jumlah Tetap'}
                        </span>
                        <span class="${isActive ? 'active-badge' : 'expired-badge'}">
                            ${isActive ? 'Aktif' : 'Kedaluwarsa'}
                        </span>
                        <br>
                        Nilai: ${discountValue}<br>
                        Berlaku: ${new Date(promo.startDate).toLocaleDateString()} - ${new Date(promo.endDate).toLocaleDateString()}
                    </div>
                    <div class="promo-controls" id="promo-controls-${promo.id}"></div>
                `;
                container.appendChild(div);

                const controlsDiv = document.getElementById(`promo-controls-${promo.id}`);

                if (role === 'ORGANIZER') {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.className = 'btn';
                    editBtn.onclick = () => openEditPromoModal(promo);
                    controlsDiv.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Hapus';
                    deleteBtn.className = 'btn delete-btn';
                    deleteBtn.onclick = () => deletePromo(promo.id);
                    controlsDiv.appendChild(deleteBtn);
                }
            });
        } catch (error) {
            console.error('Error mengambil promo:', error);
            const container = document.getElementById('promos-container');
            container.innerHTML = `<p>Error: ${error.message}</p>`;
        }
    }

    async function deletePromo(promoId) {
        if (!confirm('Apakah Anda yakin ingin menghapus promo ini?')) {
            return;
        }

        try {
            const response = await fetch(`/api/promos/${promoId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.status === 204) {
                alert('Promo berhasil dihapus!');
                await loadPromos();
            } else {
                const errorText = await response.text();
                alert('Error menghapus promo: ' + errorText);
            }
        } catch (error) {
            console.error('Error menghapus promo:', error);
            alert('Gagal menghapus promo');
        }
    }

    // Initial load
    loadPromos();
</script>
</body>
</html>